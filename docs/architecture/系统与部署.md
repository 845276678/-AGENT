# 系统与部署（草案）

环境矩阵
- Dev：本地/临时环境，调试级日志、弱限流。
- Staging：接近生产，开特性开关、强观测与压测。
- Prod：只读配置、强限流与审计、只滚动/蓝绿/金丝雀发布。

配置与密钥
- 配置：环境变量优先，支持 `.env`（本地）；集中配置服务可选。
- 密钥：KMS/Vault 托管，应用只持短期令牌；严禁提交到仓库。

发布与回滚
- 构建产物唯一、不可变；版本号与变更日志；
- 发布策略：滚动/蓝绿/金丝雀；失败自动回滚（健康检查+错误率）。

备份与灾备
- 数据库每日全量 + 每小时增量；对象存储跨区冗余；
- 目标：RPO<=15min，RTO<=30min；定期演练。

生产部署建议
- 容器化：使用 server/Dockerfile 构建镜像，`docker compose up -d` 启动。
- 进程模型：gunicorn + uvicorn.workers.UvicornWorker，多副本 + 负载均衡。
- 配置：使用环境变量与 .env 管理，密钥使用 KMS/Vault 注入（不写入镜像）。
- 健康检查：/healthz, /readyz；接入探针与弹性伸缩。
- 观测：收集结构化日志；暴露 p95 延迟、错误率、队列滞留等指标。

可观测性
- Prometheus 指标：GET /metrics（http_requests_total、http_request_duration_seconds 等）
- 访问日志：AccessLogMiddleware 输出 JSON 结构化日志（method/path/status/duration_ms/request_id）

认证与授权（JWT）
- 服务端支持三种校验策略：
  - JWKS：设置 `JWT_JWKS_URL`（推荐，自动匹配 kid 并缓存 5 分钟）
  - 非对称公钥：设置 `JWT_PUBLIC_KEY` 与 `JWT_ALGORITHMS=RS256`
  - 对称密钥：设置 `JWT_SHARED_SECRET` 与 `JWT_ALGORITHMS=HS256`
- 可选校验：`JWT_ISSUER` 与 `JWT_AUDIENCE`（启用后强制匹配）
- 中间件会在验证成功后注入 `request.state.principal = sub`，处理器可做细粒度授权。
